# Next.js Infinite Carousel

Next.js + TypeScript + Tailwind CSSで実装した、外部ライブラリ不使用の無限カルーセルコンポーネントです。

- Swiper風のアニメーション・挙動を独自実装
- 画像は10枚の絵文字カード（表裏flipアニメ付き）
- PC/モバイルでスライド数や操作性が最適化
- オートスクロール・スワイプ・ドラッグ・レスポンシブ対応

## 🚀 主な機能

- **無限スクロール**: 左右どちらにも無限に循環
- **レスポンシブ**: モバイル/PCでスライド数やUI自動調整
- **スワイプ/ドラッグ**: タッチ・マウス両対応
- **オートスクロール**: 1.5秒ごとに自動で右へスライド（操作中は一時停止・一度操作すると以降は自動スクロールが停止します）
- **カードflipアニメーション**: スライド時に表裏が反転
- **動的タイトル/カテゴリ表示**: カードごとに絵文字名・カテゴリを表示
- **パステル/ダークカラー**: カードごとにランダムな背景色
- **スクロール時の矢印表示**: 左右にスクロールした際、カード上に矢印アイコンを一時的に表示

## 🆕 新仕様: スワイプごとに新しい絵文字がランダム生成

- スワイプや自動スクロールで新しいカードが表示されるたび、**既存と重複しない新しいランダムな絵文字**がクライアント側で動的に生成・追加されます。
- これにより、無限にスワイプしても毎回異なる絵文字が現れ、同じ絵文字が繰り返し出現しません。
- このロジックは`InfiniteCarousel.tsx`で状態管理し、`getUniqueRandomEmojiPair`関数で重複チェックを行っています。

## 🚀 デプロイ

- 本プロジェクトはVercelにそのままProductionデプロイ可能です。
  - Next.js公式の標準構成に準拠しています。
  - Node.js 18以上を推奨（`package.json`の`engines`で明示）。
  - 特別な設定ファイル（vercel.json等）は不要です。

## 🛠️ 使用ライブラリ

- **next**: 15.3.3
- **react**: 19.x
- **react-dom**: 19.x
- **emoji-dictionary**: 絵文字名取得用
- **unicode-emoji-json**: 絵文字カテゴリ取得用
- **tailwindcss**: 4.x
- **typescript**: 5.x
- **eslint**: 9.x

## ⚙️ 環境構築・セットアップ

- **Node.js**: v18以上推奨

```bash
# 依存インストール
npm install

# 開発サーバー起動
npm run dev

# Lint
npm run lint

# 型チェック
npx tsc --noEmit
```

## 使い方

### 標準的な使い方

```tsx
import CarouselServer from '@/components/CarouselServer';

export default function Page() {
  return <CarouselServer />;
}
```

- `CarouselServer`が初期の絵文字配列を生成し、`InfiniteCarousel`にpropsとして渡します。
- `InfiniteCarousel`を直接使う場合は、必ず`emojiPairsArray` propsを渡してください。

### InfiniteCarouselのprops

```tsx
type EmojiPair = {
  front: { emoji: string; color: string };
  back: { emoji: string; color: string };
};

interface InfiniteCarouselProps {
  emojiPairsArray: EmojiPair[];
}
```

## 🖌️ アニメーション・UIのこだわり

- **Swiper風の詳細設定**: スライド速度・イージング・ループ・スナップ・抵抗感などを細かく再現
- **flipInXアニメーション**: スライド時にカードが表→裏→表と反転
- **カードごとに色をランダム割当**: パステル/ダーク系から自動選択
- **カードのテキスト色は背景色から自動補色**
- **PC/モバイルでスライド数・幅・アニメ挙動が自動切替**
- **カードのタイトル・カテゴリは動的に絵文字名/カテゴリを表示**
- **オートスクロールはユーザー操作時に自動停止し、以降は再開しません**
- **Tailwind CSSで柔軟にデザイン調整可能**

## 📱 対応デバイス・操作

- **PC**: マウスドラッグでスライド、左右ボタン
- **モバイル**: タッチスワイプ、左右ボタン
- **タブレット**: 両対応

## 🔧 カスタマイズ例

- スライド数やアニメーション速度は`InfiniteCarousel.tsx`の`SWIPER_CONFIG`で調整
- カードのサイズ・色・間隔はTailwindクラスや定数で調整
- 絵文字以外の画像やSVGに差し替えも可能
- **初期データ生成ロジックは`CarouselServer.tsx`、UIや挙動は`InfiniteCarousel.tsx`で調整できます**

## 📁 ディレクトリ構成

```
next-infinite-carousel/
├── src/
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   └── globals.css
│   └── components/
│       ├── CarouselServer.tsx
│       └── InfiniteCarousel.tsx
├── public/
│   ├── next.svg
│   ├── vercel.svg
│   ├── globe.svg
│   ├── window.svg
│   └── file.svg
├── package.json
└── README.md
```

## 📝 状態管理

- `currentIndex`: 現在のスライド位置
- `translateX`: 現在の移動量
- `isAnimating`: アニメーション中か
- `flippedIndexes`: flipアニメ中のインデックス集合
- `isAutoScrollStopped`: オートスクロール一時停止フラグ
- `isAnimatingAll`: 全体アニメーション中か
- `flippingBackIndexes`: flipアニメで明るい面に戻すインデックス集合
- `showCheck`: スクロール時の矢印表示フラグ
- `lastScrollDirection`: 最後のスクロール方向
- `isDragging`: ドラッグ/スワイプ中か（実装ではrefで管理）

## 🎲 絵文字が毎回ランダム生成される仕組み

このカルーセルでは、表示中のカードとその前後（先読み分）だけを「動的な配列」として管理しています。スライドを進めたり戻したりするたびに、

- 画面に表示される分＋先読み分だけの絵文字ペア配列を保持
- 進むときは末尾に新しい絵文字を追加し、先頭を削除
- 戻るときは先頭に新しい絵文字を追加し、末尾を削除
- 新しい絵文字は、現在表示・先読み中の絵文字と重複しないようにランダム生成

というロジックで、**常に新しい絵文字がランダムに生成され、同じ絵文字が繰り返し出現しません**。

この仕組みにより、無限にスライドしても毎回異なる絵文字が現れ、ユーザー体験が単調にならないよう工夫されています。

## 🧩 実装ロジック詳細

### 無限スクロールの仕組み
- カルーセルは「表示＋先読み」分だけの絵文字ペア配列（`emojiPairsArray`）を管理し、実際のDOM上には10枚×3セットの仮想的な多数のカードを並べています。
- スライド操作時、配列の先頭/末尾に新しい絵文字ペアを追加し、逆側を削除することで、常に新しいカードが現れるようにしています。
- インデックスが配列の端を超えた場合は、アニメーションを一時的に無効化して中央にジャンプし、ユーザーに無限に循環しているような体験を与えます。
- インデックスのラップ処理や巻き戻しジャンプは`slideTo`関数内で制御しています。

### flipアニメーションの仕組み
- スライド時、表示中のカードインデックスを`flippedIndexes`に追加し、CSSクラス（例: `flipInX`）で反転アニメーションを適用します。
- アニメーション終了後、`flippedIndexes`からインデックスを削除し、元の表面に戻します。
- これにより「表→裏→表」と反転する動きを実現しています。
- アニメーション中は`isAnimatingAll`フラグで一括制御し、スムーズな切り替えを担保しています。

### 正確な現在日時表示の技術的工夫
- 通常のsetInterval(1000ms)では、ブラウザのタイマー遅延やタブのバックグラウンド化などで「秒」が実際の時計より遅れることがあります。
- 本プロジェクトでは、requestAnimationFrameを使って毎フレーム時刻を更新し、秒の切り替わりを即座に検知することで、より正確な現在日時表示を実現しています。
- これにより、PC・スマホ問わず、秒単位でズレの少ないリアルタイムな時刻表示が可能です。

### ランダム絵文字表示の仕組み
- `getRandomEmoji`関数でUnicode範囲からランダムな絵文字を取得し、`emoji-dictionary`で名称が取れるもののみ採用します。
- 既に表示・先読み中の絵文字と重複しないよう、`getUniqueRandomEmojiPair`で重複チェックを行いながら新しいペアを生成します。
- 各カードは「表（パステル色）」と「裏（ダーク色）」の2面を持ち、flip時に切り替わります。

### スクロール時の矢印表示
- 左右にスクロール（ボタン・スワイプ・ホイール）した際、表示中のカード上にSVG矢印アイコンを一時的に重ねて表示します。
- スクロール方向（左/右）に応じて矢印の向きが変わります。
- 矢印は`showCheck`フラグで制御し、0.7秒間だけフェード表示されます。
- これにより、ユーザーが「どちらにスライドしたか」を直感的に把握できます。

## 制限事項

- 画像は10枚×3セットの仮想配列で管理（デフォルト）
- 外部UIライブラリ不使用
- カスタマイズはソース編集で対応

## 🤝 貢献

プルリク・イシュー歓迎！

## 📄 ライセンス

MIT License

## 🌟 アピールポイント

- **外部ライブラリ不使用でのUI/UX再現力**  
  Swiper等の有名ライブラリを使わず、アニメーション・無限スクロール・スワイプ挙動をすべて自作。ライブラリ内部の挙動を分析し、React/Next.jsの設計思想に沿って再現しました。

- **TypeScriptによる型安全な実装**  
  状態管理やprops、ユーティリティ関数まで型定義を徹底し、保守性・拡張性を意識した設計を行いました。

- **レスポンシブ&アクセシビリティ対応**  
  PC/モバイルでの操作性やUI最適化、キーボード操作やaria属性などアクセシビリティにも配慮しています。

- **アニメーション・デザインへのこだわり**  
  Tailwind CSSを活用し、柔軟かつ美しいUIを実現。flipアニメや色彩設計など、細部までユーザー体験を意識しました。

- **パフォーマンス・最適化**  
  必要な絵文字カードのみを動的に管理し、無限スクロールでもメモリ効率・パフォーマンスを維持しています。

- **実務・チーム開発を意識した設計**  
  コンポーネント分割や命名規則、コメント・READMEの充実など、他者が見ても分かりやすいコードを心がけました。

- **正確な現在日時表示**  
  秒単位で遅延の少ない、リアルタイムな現在日時を表示。requestAnimationFrameを活用し、一般的なsetIntervalよりも高精度な時刻表示を実現しています。

## 🎯 なぜサーバー/クライアントでコンポーネントを分割するのか？

- **パフォーマンス最適化**
  - サーバー側で重い処理（初期データ生成やランダム配列作成など）を実行し、クライアントには必要最小限のデータだけを渡すことで、初期表示を高速化できます。
- **セキュリティ・責務分離**
  - サーバー側でしか扱いたくないロジック（APIアクセスやシークレット、重い計算など）を分離し、クライアントにはUI描画・ユーザー操作のみを担当させることで、責務が明確になります。
- **Next.jsの設計思想に沿った構成**
  - Next.jsは「サーバーコンポーネント」と「クライアントコンポーネント」の分離を推奨しており、これに従うことで将来的なバージョンアップや機能追加にも柔軟に対応できます。
- **テスト・保守性の向上**
  - データ生成・UI描画・ユーザー操作の責務が明確になるため、テストや修正時の影響範囲が限定され、バグの混入リスクも低減します。

## 🛡️ 今後のメンテナンス性向上のためのアドバイス

- **役割ごとにファイル・ディレクトリを分ける**
  - サーバー用・クライアント用のコンポーネントは明確に分離し、命名規則（例：`Server`/`Client`/`*Container`など）を統一しましょう。
- **propsの受け渡しを明示的に**
  - サーバー側で生成したデータは、props経由でクライアント側に渡す形に統一すると、データフローが追いやすくなります。
- **「use client」ディレクティブの付与を忘れずに**
  - クライアントコンポーネントには必ず`"use client"`を先頭に記述し、意図しないサーバー実行を防ぎましょう。
- **責務の境界を意識する**
  - サーバー側は「データ生成・取得・初期化」まで、クライアント側は「UI描画・ユーザー操作・アニメーション」まで、と役割を明確に分けると、将来的な機能追加やリファクタ時も迷いません。
- **コメント・READMEの充実**
  - どのファイルがどの責務を持つか、READMEやファイル先頭コメントで明記しておくと、他の開発者が迷いません。
- **共通ロジックはhooksやlibに切り出す**
  - サーバー/クライアント両方で使うロジックは`src/lib/`や`src/hooks/`などに分離し、再利用性・テスト性を高めましょう。

> これらを意識することで、チーム開発や将来的な機能追加・リファクタリング時にも「どこを直せば良いか」「どこに何があるか」がすぐ分かる、保守性の高いプロジェクトになります。

## 🖥️ サーバーサイド・クライアントサイドの役割分担とファイル構成

本プロジェクトでは、Next.jsの「サーバーコンポーネント」と「クライアントコンポーネント」を明確に分離し、役割ごとにファイルを分けています。

- **src/components/CarouselServer.tsx**
  - サーバーサイド（Server Component）
  - 初期の絵文字カード配列（ランダム・重複なし）を生成し、クライアント側に渡す役割
  - サーバーでのみ実行されるため、データ生成や初期化処理に最適
  - `InfiniteCarousel`へpropsとしてデータを渡す

- **src/components/InfiniteCarousel.tsx**
  - クライアントサイド（Client Component）
  - 実際のカルーセルUI・アニメーション・ユーザー操作（スワイプ/ドラッグ/オートスクロール等）を担当
  - `"use client"`ディレクティブで明示的にクライアント実行
  - サーバーから受け取った絵文字配列を元に、動的なUIを描画

### 役割分担のイメージ

- サーバー側：初期データ生成・重い処理・セキュアな処理
- クライアント側：UI描画・ユーザー操作・アニメーション

#### 例
```tsx
// サーバーサイドで初期データ生成
import CarouselServer from '@/components/CarouselServer';

export default function Page() {
  return <CarouselServer />;
}
```

```tsx
// クライアントサイドでカルーセルUIを描画
import InfiniteCarousel from '@/components/InfiniteCarousel';

export default function CarouselServer() {
  // ...初期データ生成...
  return <InfiniteCarousel emojiPairsArray={arr} />;
}
```

> サーバーサイドで「初期状態の配列」を生成し、クライアントサイドで「動的なUI・操作」を担当することで、パフォーマンスと保守性を両立しています。

## クライアントコンポーネントでの現在日時表示について

本プロジェクトの `/demo/carousel` ページでは、クライアントコンポーネントとして `Clock` コンポーネントが実装されており、現在日時をリアルタイムで表示しています。

### 技術的工夫
- `Clock` コンポーネントは `useEffect` フック内で `requestAnimationFrame` を利用し、1秒未満の高頻度で現在日時を更新しています。
- これにより、秒単位でのズレがほぼ発生せず、常に正確な現在日時が表示されます。
- `setInterval` ではなく `requestAnimationFrame` を使うことで、ブラウザの描画タイミングと同期し、パフォーマンスと精度の両立を実現しています。

### 実装例（抜粋）
```tsx
import { useEffect, useState } from "react";

export default function Clock() {
  const [dateTime, setDateTime] = useState("");
  useEffect(() => {
    let raf: number | undefined;
    const updateDateTime = () => {
      const now = new Date();
      const formatted = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      setDateTime(formatted);
      raf = requestAnimationFrame(updateDateTime);
    };
    updateDateTime();
    return () => { if (raf) cancelAnimationFrame(raf); };
  }, []);
  return <span>{dateTime}</span>;
}
```

このようにして、ユーザーに常に最新の日時情報を提供しています。

### 実装のポイント
- `emojiPairsArray`はクライアント側でuseState管理され、スワイプ時に必要に応じて新しいユニークな絵文字ペアが追加されます。
- サーバー側（`CarouselServer.tsx`）は初期値として空配列を渡すだけです。
